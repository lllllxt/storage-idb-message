!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).StorageIdbMessage=n()}(this,function(){"use strict";function i(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function o(e,n){for(var r=0;r<n.length;r++){var o=n[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function e(e,n,r){return n&&o(e.prototype,n),r&&o(e,r),e}var s=function(){function n(){var r=this;i(this,n);var e=window.indexedDB.open("STORAGE_ORDER_DATA",1);e.onerror=function(e){console.log("数据库打开报错",e)},e.onsuccess=function(e){r.db=e.target.result,console.log("数据库打开成功",r.db,e)},e.onupgradeneeded=function(e){var n;r.db=e.target.result,console.log("数据库创建成功",r.db,e),r.db.objectStoreNames.contains("ORDER_DATA")||((n=r.db.createObjectStore("ORDER_DATA",{keyPath:"order_name"})).createIndex("指令名称","order_name",{unique:!1}),n.createIndex("指令数据","order_value",{unique:!1}))}}return e(n,[{key:"save",value:function(o,t){var a=this;return new Promise(function(n,r){var e=a.db.transaction(["ORDER_DATA"],"readwrite").objectStore("ORDER_DATA").put({order_name:o,order_value:t});e.onsuccess=function(e){n(e)},e.onerror=function(e){console.error("数据写入失败",e),r(e)}})}},{key:"remove",value:function(o){var t=this;return new Promise(function(n,r){var e=t.db.transaction(["ORDER_DATA"],"readwrite").objectStore("ORDER_DATA").delete(o);e.onsuccess=function(e){n(e)},e.onerror=function(e){console.error("删除数据失败",e),r(e)}})}},{key:"get",value:function(e){var t=this;return new Promise(function(n,r){var o=t.db.transaction(["ORDER_DATA"],"readonly").objectStore("ORDER_DATA").index("指令名称").get(e);o.onerror=function(e){console.error("获取数据失败",e),r(e)},o.onsuccess=function(e){n(o.result)}})}}]),n}(),c=function e(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=n.storageKey,o=void 0===r?"StorageIdbMessageOrder":r,t=n.clearIdb,a=void 0===t||t;i(this,e),this.storageKey=o,this.clearIdb=a};return function(){function a(e){var o=this;i(this,a),this.idb=new s;var n=new c(e),r=n.storageKey,t=n.clearIdb;console.log(r,t),this.STORAGE_KEY=r,window.addEventListener("storage",function(e){var n;e.key===o.STORAGE_KEY&&(n=JSON.parse(e.newValue).order,o.idb.get(n).then(function(e){var n=e.order_name,r=e.order_value;o.response(n,r),t&&o.idb.remove(n)}))})}return e(a,[{key:"send",value:function(n,e){var r=this;this.idb.save(n,e).then(function(){var e=Math.random();localStorage.setItem(r.STORAGE_KEY,JSON.stringify({order:n,random:e}))})}},{key:"response",value:function(e,n){console.log(e,n)}}]),a}()});
